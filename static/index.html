<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRG Chat</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-chat: #0f0f23;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --accent: #4a9eff;
            --accent-hover: #3a8eef;
            --user-msg: #2d4a7c;
            --assistant-msg: #1e3a5f;
            --border: #2a2a4a;
            --success: #4ade80;
            --error: #f87171;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--bg-secondary);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1::before {
            content: '';
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent), #7c3aed);
            border-radius: 8px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.offline { background: var(--error); }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .new-chat-btn {
            width: 100%;
            padding: 10px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .new-chat-btn:hover { background: var(--accent-hover); }

        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .session-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: background 0.2s;
        }

        .session-item:hover { background: rgba(255,255,255,0.05); }

        .session-item.active {
            background: rgba(74, 158, 255, 0.15);
            border: 1px solid rgba(74, 158, 255, 0.3);
        }

        .session-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-chat);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 80%;
            padding: 14px 18px;
            border-radius: 12px;
            line-height: 1.5;
            font-size: 14px;
        }

        .message.user {
            background: var(--user-msg);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: var(--assistant-msg);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.system {
            background: rgba(255,255,255,0.05);
            align-self: center;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .message-content {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .citations {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 12px;
        }

        .citations-title {
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .citation {
            background: rgba(255,255,255,0.05);
            padding: 6px 10px;
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .input-area {
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-container {
            flex: 1;
            position: relative;
        }

        textarea {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-chat);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 52px;
            max-height: 200px;
            line-height: 1.5;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea::placeholder { color: var(--text-secondary); }

        .send-btn {
            padding: 14px 24px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .send-btn:hover:not(:disabled) { background: var(--accent-hover); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .options {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 13px;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
        }

        .option input[type="checkbox"] { accent-color: var(--accent); }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 14px 18px;
            background: var(--assistant-msg);
            border-radius: 12px;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .welcome {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-secondary);
        }

        .welcome h2 {
            color: var(--text-primary);
            font-size: 24px;
            margin-bottom: 12px;
        }

        .welcome p {
            font-size: 14px;
            line-height: 1.6;
            max-width: 500px;
            margin: 0 auto;
        }

        .empty-sessions {
            padding: 16px;
            color: var(--text-secondary);
            font-size: 13px;
            text-align: center;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="header">
        <h1>SRG Chat</h1>
        <div class="status">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Connecting...</span>
        </div>
    </div>

    <div class="main">
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="newChatBtn">+ New Chat</button>
            </div>
            <div class="sessions-list" id="sessionsList"></div>
        </div>

        <div class="chat-container">
            <div class="messages" id="messages"></div>

            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-container">
                        <textarea
                            id="messageInput"
                            placeholder="Ask a question about your documents..."
                            rows="1"
                        ></textarea>
                    </div>
                    <button class="send-btn" id="sendBtn">Send</button>
                </div>
                <div class="options">
                    <label class="option">
                        <input type="checkbox" id="useRag" checked>
                        <span>Use RAG</span>
                    </label>
                    <label class="option">
                        <input type="checkbox" id="includeSources" checked>
                        <span>Show Sources</span>
                    </label>
                    <label class="option">
                        <input type="checkbox" id="useStream">
                        <span>Stream Response</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let currentSessionId = null;
        let isLoading = false;

        // DOM elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const sessionsList = document.getElementById('sessionsList');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const useRagCheckbox = document.getElementById('useRag');
        const includeSourcesCheckbox = document.getElementById('includeSources');
        const useStreamCheckbox = document.getElementById('useStream');

        // Event listeners
        newChatBtn.addEventListener('click', newChat);
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', handleKeyDown);
        messageInput.addEventListener('input', function() { autoResize(this); });

        // Check health
        async function checkHealth() {
            try {
                const res = await fetch(API_BASE + '/api/health');
                await res.json();
                statusDot.classList.remove('offline');
                statusText.textContent = 'Connected';
            } catch (e) {
                statusDot.classList.add('offline');
                statusText.textContent = 'Offline';
            }
        }

        // Load sessions
        async function loadSessions() {
            try {
                const res = await fetch(API_BASE + '/api/sessions');
                const data = await res.json();
                renderSessions(data.sessions || []);
            } catch (e) {
                console.error('Failed to load sessions:', e);
            }
        }

        function renderSessions(sessions) {
            sessionsList.replaceChildren();

            if (!sessions.length) {
                const empty = document.createElement('div');
                empty.className = 'empty-sessions';
                empty.textContent = 'No sessions yet';
                sessionsList.appendChild(empty);
                return;
            }

            sessions.forEach(function(s) {
                const item = document.createElement('div');
                item.className = 'session-item' + (s.id === currentSessionId ? ' active' : '');
                item.addEventListener('click', function() { selectSession(s.id); });

                const title = document.createElement('div');
                title.className = 'session-title';
                title.textContent = s.title || 'Untitled';

                const meta = document.createElement('div');
                meta.className = 'session-meta';
                meta.textContent = s.message_count + ' messages';

                item.appendChild(title);
                item.appendChild(meta);
                sessionsList.appendChild(item);
            });
        }

        async function selectSession(sessionId) {
            currentSessionId = sessionId;
            loadSessions();

            try {
                const res = await fetch(API_BASE + '/api/sessions/' + sessionId + '/messages');
                const data = await res.json();
                renderMessages(data.messages || []);
            } catch (e) {
                console.error('Failed to load messages:', e);
            }
        }

        function renderMessages(messages) {
            messagesContainer.replaceChildren();

            if (!messages.length) {
                showWelcome();
                return;
            }

            messages.forEach(function(m) {
                addMessageElement(m.role, m.content);
            });
            scrollToBottom();
        }

        function showWelcome() {
            messagesContainer.replaceChildren();

            const welcome = document.createElement('div');
            welcome.className = 'welcome';

            const h2 = document.createElement('h2');
            h2.textContent = 'Welcome to SRG Chat';

            const p = document.createElement('p');
            p.textContent = 'Ask questions about your invoices and documents. RAG-powered search retrieves relevant context to provide accurate answers.';

            welcome.appendChild(h2);
            welcome.appendChild(p);
            messagesContainer.appendChild(welcome);
        }

        function newChat() {
            currentSessionId = null;
            loadSessions();
            showWelcome();
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || isLoading) return;

            isLoading = true;
            sendBtn.disabled = true;

            // Remove welcome if present
            const welcome = messagesContainer.querySelector('.welcome');
            if (welcome) welcome.remove();

            // Add user message
            addMessageElement('user', message);
            messageInput.value = '';
            autoResize(messageInput);

            // Show typing
            showTyping();

            const useStream = useStreamCheckbox.checked;

            try {
                const payload = {
                    message: message,
                    session_id: currentSessionId,
                    use_rag: useRagCheckbox.checked,
                    include_sources: includeSourcesCheckbox.checked,
                    stream: useStream,
                    top_k: 5
                };

                if (useStream) {
                    await handleStreamResponse(payload);
                } else {
                    await handleNormalResponse(payload);
                }
            } catch (e) {
                hideTyping();
                addMessageElement('system', 'Error: ' + e.message);
            }

            isLoading = false;
            sendBtn.disabled = false;
        }

        async function handleNormalResponse(payload) {
            const res = await fetch(API_BASE + '/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            hideTyping();

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || 'Request failed');
            }

            const data = await res.json();
            currentSessionId = data.session_id;

            addMessageElement('assistant', data.message.content, data.citations);
            loadSessions();
        }

        async function handleStreamResponse(payload) {
            const res = await fetch(API_BASE + '/api/chat/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            hideTyping();

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || 'Request failed');
            }

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let content = '';
            let messageEl = null;

            while (true) {
                const result = await reader.read();
                if (result.done) break;

                const chunk = decoder.decode(result.value);
                const lines = chunk.split('\n');

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.indexOf('data: ') === 0) {
                        const data = line.substring(6);
                        if (data === '[DONE]') {
                            loadSessions();
                            continue;
                        }
                        if (data.indexOf('[ERROR]') === 0) {
                            throw new Error(data.substring(8));
                        }

                        content += data;

                        if (!messageEl) {
                            messageEl = addMessageElement('assistant', content);
                        } else {
                            const contentEl = messageEl.querySelector('.message-content');
                            contentEl.textContent = content;
                        }
                        scrollToBottom();
                    }
                }
            }
        }

        function addMessageElement(role, content, citations) {
            const div = document.createElement('div');
            div.className = 'message ' + role;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            div.appendChild(contentDiv);

            if (citations && citations.length > 0) {
                const citationsDiv = document.createElement('div');
                citationsDiv.className = 'citations';

                const title = document.createElement('div');
                title.className = 'citations-title';
                title.textContent = 'Sources:';
                citationsDiv.appendChild(title);

                citations.forEach(function(c) {
                    const citation = document.createElement('div');
                    citation.className = 'citation';
                    let text = c.file_name || c.document_id;
                    if (c.page_number) {
                        text += ' (p. ' + c.page_number + ')';
                    }
                    text += ' - Score: ' + Math.round(c.relevance_score * 100) + '%';
                    citation.textContent = text;
                    citationsDiv.appendChild(citation);
                });

                div.appendChild(citationsDiv);
            }

            messagesContainer.appendChild(div);
            scrollToBottom();
            return div;
        }

        function showTyping() {
            const div = document.createElement('div');
            div.className = 'typing-indicator';
            div.id = 'typingIndicator';
            for (let i = 0; i < 3; i++) {
                div.appendChild(document.createElement('span'));
            }
            messagesContainer.appendChild(div);
            scrollToBottom();
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 200) + 'px';
        }

        // Initialize
        checkHealth();
        loadSessions();
        showWelcome();
        setInterval(checkHealth, 30000);
    </script>
</body>
</html>
